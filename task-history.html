
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task History - Daily Campaign King</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="style.css">
  <style>
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 10px 0;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }
    .bottom-nav .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
      transition: color 0.3s ease;
    }
    .bottom-nav .nav-item i {
      font-size: 20px;
      margin-bottom: 5px;
    }
    .bottom-nav .nav-item.active {
      color: white;
      font-weight: bold;
    }

    .history-card {
      animation: slideInUp 0.5s ease-out;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
    }

    .history-card:hover {
      transform: translateY(-8px) scale(1.02);
    }

    .status-approved {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .status-rejected {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .status-pending {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .floating-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      animation: pulse 2s infinite;
    }

    .earnings-box {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 15px;
      padding: 15px;
      position: relative;
      overflow: hidden;
    }

    .earnings-box::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      animation: shimmer 3s infinite;
    }
  </style>
</head>
<body style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0; padding: 0; min-height: 100vh;">
  <nav class="navbar navbar-dark" style="background: rgba(0, 0, 0, 0.2); backdrop-filter: blur(10px); margin: 0; padding: 8px 0; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
    <div class="container-fluid" style="padding: 0 10px;">
      <span class="navbar-brand mb-0" style="font-weight: 700; font-size: 1.1rem;"><i class="bi bi-clock-history"></i> Task History</span>
      <button onclick="window.location.href='dashboard.html'" class="btn btn-light btn-sm" style="border-radius: 20px; padding: 6px 16px; font-weight: 600; font-size: 0.85rem;"><i class="bi bi-house-door-fill"></i> Home</button>
    </div>
  </nav>

  <div class="container-fluid" style="padding: 20px 15px 100px 15px; max-width: 100%;">
    <div class="row g-3 mb-4">
      <div class="col-4">
        <div class="text-center" style="background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 20px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
            <i class="bi bi-list-task" style="font-size: 1.5rem; color: white;"></i>
          </div>
          <h3 style="margin: 0; font-weight: 800; color: #2c3e50;"><span id="totalTasks">0</span></h3>
          <small style="color: #7f8c8d; font-weight: 600;">Total</small>
        </div>
      </div>
      <div class="col-4">
        <div class="text-center" style="background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 20px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);">
          <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
            <i class="bi bi-check-circle-fill" style="font-size: 1.5rem; color: white;"></i>
          </div>
          <h3 style="margin: 0; font-weight: 800; color: #10b981;"><span id="approvedTasks">0</span></h3>
          <small style="color: #7f8c8d; font-weight: 600;">Approved</small>
        </div>
      </div>
      <div class="col-4">
        <div class="text-center" style="background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 20px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);">
          <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px;">
            <i class="bi bi-clock-fill" style="font-size: 1.5rem; color: white;"></i>
          </div>
          <h3 style="margin: 0; font-weight: 800; color: #f59e0b;"><span id="pendingTasks">0</span></h3>
          <small style="color: #7f8c8d; font-weight: 600;">Pending</small>
        </div>
      </div>
    </div>

    <div id="tasksContainer">
      <div class="text-center" style="padding: 60px 0;">
        <div style="background: rgba(255, 255, 255, 0.1); border-radius: 50%; width: 80px; height: 80px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
          <div class="spinner-border text-white" role="status" style="width: 50px; height: 50px;"></div>
        </div>
        <p class="mt-2" style="color: white; font-weight: 600; font-size: 1.1rem;">Loading your tasks...</p>
      </div>
    </div>
  </div>

  <nav class="bottom-nav">
    <a href="dashboard.html" class="nav-item">
      <i class="bi bi-house-door-fill"></i>
      <span>Home</span>
    </a>
    <a href="tasks-page.html" class="nav-item">
      <i class="bi bi-list-task"></i>
      <span>Tasks</span>
    </a>
    <a href="task-history.html" class="nav-item active">
      <i class="bi bi-clock-history"></i>
      <span>History</span>
    </a>
    <a href="wallet.html" class="nav-item">
      <i class="bi bi-wallet2"></i>
      <span>Wallet</span>
    </a>
    <a href="profile.html" class="nav-item">
      <i class="bi bi-person-fill"></i>
      <span>Profile</span>
    </a>
  </nav>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="script.js"></script>
  <script src="custom-auth.js"></script>
  <script>
    let currentUserId = null;

    customAuth.onAuthStateChanged((user) => {
      if (user) {
        currentUserId = user.userId;
        loadTaskHistory();
        trackPageView('Task History');
      } else {
        window.location.href = 'index.html';
      }
    });

    function loadTaskHistory() {
      const tasksRef = firebase.database().ref('tasks').orderByChild('userId').equalTo(currentUserId);

      tasksRef.on('value', (snapshot) => {
        const tasks = snapshot.val();
        const container = document.getElementById('tasksContainer');

        if (!tasks) {
          container.innerHTML = `
            <div style="background: rgba(255, 255, 255, 0.95); border-radius: 25px; padding: 50px 20px; text-align: center; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);">
              <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                <i class="bi bi-inbox" style="font-size: 3rem; color: white;"></i>
              </div>
              <h4 style="color: #2c3e50; font-weight: 700; margin-bottom: 10px;">No Tasks Yet!</h4>
              <p style="color: #7f8c8d; margin-bottom: 25px;">Start completing tasks to see your history here</p>
              <a href="tasks-page.html" class="btn btn-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 30px; padding: 15px 40px; font-weight: 700; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);">
                <i class="bi bi-plus-circle-fill"></i> Browse Tasks
              </a>
            </div>
          `;
          updateStats(0, 0, 0);
          return;
        }

        let totalCount = 0;
        let approvedCount = 0;
        let pendingCount = 0;

        let html = '<div class="row g-3">';

        Object.entries(tasks).reverse().forEach(([taskId, task]) => {
          totalCount++;

          let statusClass, statusIcon, statusText, statusGradient, borderColor;
          if (task.status === 'approved') {
            statusClass = 'status-approved';
            statusIcon = 'bi-check-circle-fill';
            statusText = 'Approved';
            statusGradient = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            borderColor = '#10b981';
            approvedCount++;
          } else if (task.status === 'rejected') {
            statusClass = 'status-rejected';
            statusIcon = 'bi-x-circle-fill';
            statusText = 'Rejected';
            statusGradient = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            borderColor = '#ef4444';
          } else {
            statusClass = 'status-pending';
            statusIcon = 'bi-clock-fill';
            statusText = 'Pending';
            statusGradient = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            borderColor = '#f59e0b';
            pendingCount++;
          }

          const submitDate = task.submittedAt ? new Date(task.submittedAt).toLocaleString('en-IN', { 
            day: 'numeric', 
            month: 'short', 
            hour: '2-digit', 
            minute: '2-digit' 
          }) : 'N/A';

          html += `
            <div class="col-12" style="margin-bottom: 15px;">
              <div class="history-card" style="background: rgba(255, 255, 255, 0.95); border-radius: 18px; overflow: hidden; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); border-left: 5px solid ${borderColor}; position: relative;">
                
                ${task.rejectionReason ? `
                <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); padding: 12px 15px; color: white;">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="bi bi-exclamation-triangle-fill" style="font-size: 1.3rem;"></i>
                    <div style="flex: 1;">
                      <strong style="display: block; margin-bottom: 3px; font-size: 0.95rem;">Rejection Reason</strong>
                      <p style="margin: 0; font-size: 0.85rem; opacity: 0.95; line-height: 1.4;">${task.rejectionReason}</p>
                    </div>
                  </div>
                </div>
                ` : ''}

                <span class="floating-badge badge ${statusClass}" style="padding: 8px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);">
                  <i class="${statusIcon}"></i> ${statusText}
                </span>

                <div style="padding: 18px 15px;">
                  <div style="margin-bottom: 12px;">
                    <h5 style="color: #2c3e50; font-weight: 700; margin: 0 0 6px 0; font-size: 1.1rem; padding-right: 110px;">
                      <i class="bi bi-award-fill" style="color: ${borderColor};"></i> ${task.taskTitle || 'Task #' + task.taskNumber}
                    </h5>
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <i class="bi bi-calendar-check" style="color: #7f8c8d; font-size: 0.9rem;"></i>
                      <small style="color: #95a5a6; font-weight: 600; font-size: 0.8rem;">${submitDate}</small>
                    </div>
                  </div>

                  <div class="earnings-box" style="padding: 12px;">
                    <div class="row align-items-center">
                      <div class="col-7">
                        <small style="color: #7f8c8d; font-weight: 600; text-transform: uppercase; font-size: 0.7rem; display: block; margin-bottom: 4px;">
                          <i class="bi bi-cash-coin"></i> Earnings
                        </small>
                        <h3 style="margin: 0; font-weight: 800; background: ${statusGradient}; -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.8rem;">
                          â‚¹${task.amount || 0}
                        </h3>
                      </div>
                      ${task.screenshot ? `
                      <div class="col-5 text-end">
                        <button onclick="viewScreenshot('${task.screenshot}')" class="btn btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 20px; padding: 8px 15px; font-weight: 700; font-size: 0.85rem; box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);">
                          <i class="bi bi-image-fill"></i> View
                        </button>
                      </div>
                      ` : ''}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        });

        html += '</div>';
        container.innerHTML = html;
        updateStats(totalCount, approvedCount, pendingCount);
      });

      listenForApprovals();
    }

    function listenForApprovals() {
      const tasksRef = firebase.database().ref('tasks').orderByChild('userId').equalTo(currentUserId);

      tasksRef.on('child_changed', async (snapshot) => {
        const task = snapshot.val();
        const taskId = snapshot.key;

        if (task.status === 'approved' && !task.creditProcessed) {
          const userRef = firebase.database().ref('users/' + currentUserId);
          const userSnapshot = await userRef.once('value');
          const userData = userSnapshot.val();

          if (userData) {
            const newBalance = (userData.balance || 0) + (task.amount || 0);
            const newTaskEarnings = (userData.taskEarnings || 0) + (task.amount || 0);

            await userRef.update({
              balance: newBalance,
              taskEarnings: newTaskEarnings
            });

            await firebase.database().ref('tasks/' + taskId).update({
              creditProcessed: true
            });

            showEarningNotification(task.amount || 0);
          }
        }
      });
    }

    function showEarningNotification(amount) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
        z-index: 9999;
        animation: slideInUp 0.5s ease-out;
        min-width: 300px;
        text-align: center;
      `;
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 15px; justify-content: center;">
          <i class="bi bi-check-circle-fill" style="font-size: 2.5rem;"></i>
          <div>
            <h5 style="margin: 0 0 5px 0; font-weight: 700;">Task Approved! ðŸŽ‰</h5>
            <p style="margin: 0; opacity: 0.95; font-size: 1.1rem; font-weight: 600;">â‚¹${amount} added to wallet</p>
          </div>
        </div>
      `;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.animation = 'slideInUp 0.5s ease-out reverse';
        setTimeout(() => notification.remove(), 500);
      }, 4000);
    }

    function updateStats(total, approved, pending) {
      document.getElementById('totalTasks').textContent = total;
      document.getElementById('approvedTasks').textContent = approved;
      document.getElementById('pendingTasks').textContent = pending;
    }

    function viewScreenshot(url) {
      window.open(url, '_blank');
    }

    function trackPageView(pageName) {
      console.log(`Page view: ${pageName}`);
    }
  </script>
</body>
</html>
