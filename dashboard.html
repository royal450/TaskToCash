
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Daily Campaign King</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>
<body style="background: #f5f7fa; margin: 0; padding: 0;">
  <nav class="navbar navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0; padding: 15px;">
    <div class="container-fluid" style="padding: 0 5px;">
      <span class="navbar-brand mb-0 h1"><i class="bi bi-house-heart-fill"></i> Daily Campaign King</span>
      <button onclick="window.location.href='steps.html'" class="btn btn-light btn-sm"><i class="bi bi-question-circle"></i></button>
    </div>
  </nav>

  <div class="container-fluid" style="padding: 15px 5px; max-width: 100%;">
    <div class="card shadow-sm mb-3" style="border: none; border-radius: 15px;">
      <div class="card-body" style="padding: 20px;">
        <h5 style="color: #667eea; font-weight: 600; margin-bottom: 15px;">
          <i class="bi bi-person-circle"></i> Welcome, <span id="userEmail">User</span>!
        </h5>
        <div class="row g-2">
          <div class="col-6">
            <div class="stat-box" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
              <h3 style="font-size: 1.8rem; margin: 0; font-weight: 700;">₹<span id="userBalance">0</span></h3>
              <p style="margin: 5px 0 0 0; font-size: 0.8rem; opacity: 0.9;">Balance</p>
            </div>
          </div>
          <div class="col-6">
            <div class="stat-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
              <h3 style="font-size: 1.8rem; margin: 0; font-weight: 700;"><span id="totalReferrals">0</span></h3>
              <p style="margin: 5px 0 0 0; font-size: 0.8rem; opacity: 0.9;">Referrals</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-3" style="border: none; border-radius: 15px;">
      <div class="card-body" style="padding: 20px;">
        <h6 style="color: #667eea; font-weight: 600; margin-bottom: 15px;"><i class="bi bi-lightning-charge-fill"></i> Quick Actions</h6>
        <div class="row g-2">
          <div class="col-6">
            <button onclick="window.location.href='tasks-page.html'" class="btn w-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; padding: 15px; border: none; font-weight: 600;">
              <i class="bi bi-list-task" style="font-size: 1.5rem; display: block; margin-bottom: 5px;"></i>
              <span style="font-size: 0.85rem;">Browse Tasks</span>
            </button>
          </div>
          <div class="col-6">
            <button onclick="window.location.href='wallet.html'" class="btn w-100" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-radius: 10px; padding: 15px; border: none; font-weight: 600;">
              <i class="bi bi-wallet2" style="font-size: 1.5rem; display: block; margin-bottom: 5px;"></i>
              <span style="font-size: 0.85rem;">Withdraw</span>
            </button>
          </div>
          <div class="col-6">
            <button onclick="window.location.href='task-history.html'" class="btn w-100" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 10px; padding: 15px; border: none; font-weight: 600;">
              <i class="bi bi-clock-history" style="font-size: 1.5rem; display: block; margin-bottom: 5px;"></i>
              <span style="font-size: 0.85rem;">Task History</span>
            </button>
          </div>
          <div class="col-6">
            <button onclick="window.location.href='profile.html'" class="btn w-100" style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); color: white; border-radius: 10px; padding: 15px; border: none; font-weight: 600;">
              <i class="bi bi-person-circle" style="font-size: 1.5rem; display: block; margin-bottom: 5px;"></i>
              <span style="font-size: 0.85rem;">My Profile</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm" style="border: none; border-radius: 15px; margin-bottom: 15px;">
      <div class="card-body" style="padding: 20px;">
        <h6 style="color: #667eea; font-weight: 600; margin-bottom: 15px;"><i class="bi bi-clock-history"></i> Recent Task History</h6>
        <div id="taskHistory">
          <p class="text-center text-muted">Loading...</p>
        </div>
      </div>
    </div>

    <a href="https://wa.me/919876543210?text=Hi%2C%20I%20need%20help%20with%20Daily%20Campaign%20King" target="_blank" class="btn w-100 mb-3" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border-radius: 10px; padding: 15px; border: none; font-weight: 600; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4); margin-bottom: 70px;">
      <i class="bi bi-whatsapp" style="font-size: 1.3rem;"></i> WhatsApp Support
    </a>
  </div>

  <nav class="bottom-nav">
    <a href="dashboard.html" class="nav-item active">
      <i class="bi bi-house-door-fill"></i>
      <span>Home</span>
    </a>
    <a href="tasks-page.html" class="nav-item">
      <i class="bi bi-list-task"></i>
      <span>Tasks</span>
    </a>
    <a href="task-history.html" class="nav-item">
      <i class="bi bi-clock-history"></i>
      <span>History</span>
    </a>
    <a href="wallet.html" class="nav-item">
      <i class="bi bi-wallet2"></i>
      <span>Wallet</span>
    </a>
    <a href="profile.html" class="nav-item">
      <i class="bi bi-person-fill"></i>
      <span>Profile</span>
    </a>
  </nav>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="script.js"></script>
  <script src="custom-auth.js"></script>
  <script>
    let currentUser = null;

    customAuth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        const userSnapshot = await firebase.database().ref('users/' + user.userId).once('value');
        const userData = userSnapshot.val();
        
        if (userData && userData.blocked === true) {
          Swal.fire({
            icon: 'error',
            title: 'Account Blocked',
            text: 'Your account has been blocked. Contact support for assistance.',
            confirmButtonColor: '#dc3545',
            allowOutsideClick: false
          }).then(() => {
            customAuth.signOut();
            window.location.href = 'index.html';
          });
          return;
        }
        
        loadUserData(user.userId);
        loadTaskHistory(user.userId);
        trackPageView('Dashboard');
      } else {
        window.location.href = 'index.html';
      }
    });

    function loadUserData(userId) {
      console.log('Loading dashboard data for:', userId);
      firebase.database().ref('users/' + userId).on('value', (snapshot) => {
        const data = snapshot.val();
        console.log('Dashboard data received:', data);
        
        if (data) {
          document.getElementById('userEmail').textContent = data.email || 'User';
          document.getElementById('userBalance').textContent = data.balance || 0;
          document.getElementById('totalReferrals').textContent = data.totalReferrals || 0;
          
          if (data.referralCode) {
            localStorage.setItem('userReferralCode', data.referralCode);
          }
        } else {
          console.log('User data not found, initializing...');
          // Initialize user data if missing
          const newUserData = {
            email: currentUser.email,
            referralCode: 'REF' + userId.substring(0, 8).toUpperCase(),
            balance: 0,
            taskEarnings: 0,
            referralEarnings: 0,
            totalReferrals: 0,
            joinedAt: Date.now(),
            blocked: false,
            upiId: ''
          };
          firebase.database().ref('users/' + userId).set(newUserData).then(() => {
            console.log('User data initialized successfully');
            location.reload();
          });
        }
      }, (error) => {
        console.error('Error loading dashboard data:', error);
      });
    }

    function loadTaskHistory(userId) {
      firebase.database().ref('tasks').orderByChild('userId').equalTo(userId).limitToLast(5).on('value', (snapshot) => {
        const tasks = snapshot.val();
        let html = '';
        
        if (!tasks) {
          html = '<p class="text-center text-muted" style="padding: 20px 0;">No tasks submitted yet. Start completing tasks to earn money!</p>';
        } else {
          const taskArray = Object.values(tasks).reverse();
          taskArray.forEach(task => {
            const date = new Date(task.submittedAt).toLocaleDateString('en-IN');
            let statusColor, statusIcon;
            if (task.status === 'approved') {
              statusColor = '#11998e';
              statusIcon = 'check-circle-fill';
            } else if (task.status === 'rejected') {
              statusColor = '#dc3545';
              statusIcon = 'x-circle-fill';
            } else {
              statusColor = '#ffc107';
              statusIcon = 'clock-fill';
            }
            
            html += `
              <div class="d-flex justify-content-between align-items-center mb-3 pb-3" style="border-bottom: 1px solid #eee;">
                <div>
                  <h6 style="margin: 0; font-weight: 600; color: #333;">${task.taskTitle || 'Task'}</h6>
                  <small class="text-muted">${date} • ₹${task.taskPrice || 2}</small>
                </div>
                <div class="text-end">
                  <i class="bi bi-${statusIcon}" style="color: ${statusColor}; font-size: 1.5rem;"></i>
                  <br>
                  <small style="color: ${statusColor}; font-weight: 600;">${task.status}</small>
                </div>
              </div>
            `;
          });
        }
        
        document.getElementById('taskHistory').innerHTML = html;
      }, (error) => {
        console.error('Error loading task history:', error);
        document.getElementById('taskHistory').innerHTML = '<p class="text-center text-muted">Error loading tasks</p>';
      });
    }
  </script>
</body>
</html>
