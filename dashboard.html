
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Daily Campaign King</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>
<body style="background: #f5f7fa; margin: 0; padding: 0;">
  <nav class="navbar navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0; padding: 8px 0;">
    <div class="container-fluid" style="padding: 0 10px;">
      <span class="navbar-brand mb-0" style="font-size: 1.1rem; font-weight: 700;"><i class="bi bi-house-heart-fill"></i> Daily Campaign King</span>
      <button onclick="window.location.href='steps.html'" class="btn btn-light btn-sm" style="padding: 6px 12px; font-size: 0.85rem;"><i class="bi bi-question-circle"></i></button>
    </div>
  </nav>

  <div class="container-fluid" style="padding: 12px 8px 100px 8px; max-width: 100%;">
    <div style="background: white; border-radius: 18px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.06);">
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
          <i class="bi bi-person-circle"></i>
        </div>
        <div>
          <h6 style="margin: 0; font-weight: 700; color: #1a1a1a; font-size: 0.9rem;">Welcome back!</h6>
          <p style="margin: 0; color: #666; font-size: 0.75rem;"><span id="userEmail">User</span></p>
        </div>
      </div>
      <div class="row g-2">
        <div class="col-6">
          <div style="background: linear-gradient(135deg, #11998e15 0%, #38ef7d15 100%); border: 2px solid #11998e30; padding: 15px 12px; border-radius: 15px; text-align: center;">
            <div style="color: #11998e; font-size: 1.6rem; font-weight: 900; margin-bottom: 4px;">₹<span id="userBalance">0</span></div>
            <div style="color: #11998e; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Balance</div>
          </div>
        </div>
        <div class="col-6">
          <div style="background: linear-gradient(135deg, #f093fb15 0%, #f5576c15 100%); border: 2px solid #f5576c30; padding: 15px 12px; border-radius: 15px; text-align: center;">
            <div style="color: #f5576c; font-size: 1.6rem; font-weight: 900; margin-bottom: 4px;"><span id="totalReferrals">0</span></div>
            <div style="color: #f5576c; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Referrals</div>
          </div>
        </div>
      </div>
    </div>

    <div style="background: white; border-radius: 18px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.06);">
      <h6 style="color: #1a1a1a; font-weight: 800; margin-bottom: 12px; font-size: 0.85rem;"><i class="bi bi-lightning-charge-fill" style="color: #FFD700;"></i> Quick Actions</h6>
      <div class="row g-2">
        <div class="col-6">
          <button onclick="window.location.href='tasks-page.html'" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; padding: 12px 8px; font-weight: 700; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); transition: all 0.3s;">
            <i class="bi bi-list-task" style="font-size: 1.8rem; display: block; margin-bottom: 6px;"></i>
            <span style="font-size: 0.75rem;">Tasks</span>
          </button>
        </div>
        <div class="col-6">
          <button onclick="window.location.href='wallet.html'" style="width: 100%; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 15px; padding: 12px 8px; font-weight: 700; box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3); transition: all 0.3s;">
            <i class="bi bi-wallet2" style="font-size: 1.8rem; display: block; margin-bottom: 6px;"></i>
            <span style="font-size: 0.75rem;">Withdraw</span>
          </button>
        </div>
        <div class="col-6">
          <button onclick="window.location.href='task-history.html'" style="width: 100%; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 15px; padding: 12px 8px; font-weight: 700; box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3); transition: all 0.3s;">
            <i class="bi bi-clock-history" style="font-size: 1.8rem; display: block; margin-bottom: 6px;"></i>
            <span style="font-size: 0.75rem;">History</span>
          </button>
        </div>
        <div class="col-6">
          <button onclick="window.location.href='profile.html'" style="width: 100%; background: linear-gradient(135deg, #FA8BFF 0%, #2BD2FF 100%); color: white; border: none; border-radius: 15px; padding: 12px 8px; font-weight: 700; box-shadow: 0 4px 12px rgba(250, 139, 255, 0.3); transition: all 0.3s;">
            <i class="bi bi-person-circle" style="font-size: 1.8rem; display: block; margin-bottom: 6px;"></i>
            <span style="font-size: 0.75rem;">Profile</span>
          </button>
        </div>
      </div>
    </div>

    <div class="card shadow-sm" style="border: none; border-radius: 15px; margin-bottom: 15px;">
      <div class="card-body" style="padding: 20px;">
        <h6 style="color: #667eea; font-weight: 600; margin-bottom: 15px;"><i class="bi bi-clock-history"></i> Recent Task History</h6>
        <div id="taskHistory">
          <p class="text-center text-muted">Loading...</p>
        </div>
      </div>
    </div>

    <a href="https://wa.me/919104037184?text=Hi%2C%20I%20need%20help%20with%20Daily%20Campaign%20King" target="_blank" class="btn w-100 mb-3" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border-radius: 10px; padding: 15px; border: none; font-weight: 600; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4); margin-bottom: 70px;">
      <i class="bi bi-whatsapp" style="font-size: 1.3rem;"></i> WhatsApp Support
    </a>
  </div>

  <nav class="bottom-nav">
    <a href="tasks-page.html" class="nav-item">
      <i class="bi bi-list-task"></i>
      <span>Tasks</span>
    </a>
    <a href="task-history.html" class="nav-item">
      <i class="bi bi-clock-history"></i>
      <span>History</span>
    </a>
    <a href="wallet.html" class="nav-item">
      <i class="bi bi-wallet2"></i>
      <span>Wallet</span>
    </a>
    <a href="profile.html" class="nav-item">
      <i class="bi bi-gift-fill"></i>
      <span>Referral</span>
    </a>
    <a href="dashboard.html" class="nav-item active">
      <i class="bi bi-gear-fill"></i>
      <span>Settings</span>
    </a>
  </nav>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="script.js"></script>
  <script src="custom-auth.js"></script>
  <script>
    let currentUser = null;

    customAuth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        const userSnapshot = await firebase.database().ref('users/' + user.userId).once('value');
        const userData = userSnapshot.val();
        
        if (userData && userData.blocked === true) {
          Swal.fire({
            icon: 'error',
            title: 'Account Blocked',
            text: 'Your account has been blocked. Contact support for assistance.',
            confirmButtonColor: '#dc3545',
            allowOutsideClick: false
          }).then(() => {
            customAuth.signOut();
            window.location.href = 'index.html';
          });
          return;
        }
        
        loadUserData(user.userId);
        loadTaskHistory(user.userId);
        trackPageView('Dashboard');
      } else {
        window.location.href = 'index.html';
      }
    });

    function loadUserData(userId) {
      console.log('Loading dashboard data for:', userId);
      firebase.database().ref('users/' + userId).on('value', (snapshot) => {
        const data = snapshot.val();
        console.log('Dashboard data received:', data);
        
        if (data) {
          document.getElementById('userEmail').textContent = data.email || 'User';
          document.getElementById('userBalance').textContent = data.balance || 0;
          document.getElementById('totalReferrals').textContent = data.totalReferrals || 0;
          
          if (data.referralCode) {
            localStorage.setItem('userReferralCode', data.referralCode);
          }
        } else {
          console.log('User data not found, initializing...');
          // Initialize user data if missing
          const newUserData = {
            email: currentUser.email,
            referralCode: 'REF' + userId.substring(0, 8).toUpperCase(),
            balance: 0,
            taskEarnings: 0,
            referralEarnings: 0,
            totalReferrals: 0,
            joinedAt: Date.now(),
            blocked: false,
            upiId: ''
          };
          firebase.database().ref('users/' + userId).set(newUserData).then(() => {
            console.log('User data initialized successfully');
            location.reload();
          });
        }
      }, (error) => {
        console.error('Error loading dashboard data:', error);
      });
    }

    function loadTaskHistory(userId) {
      firebase.database().ref('tasks').orderByChild('userId').equalTo(userId).limitToLast(5).on('value', (snapshot) => {
        const tasks = snapshot.val();
        let html = '';
        
        if (!tasks) {
          html = '<p class="text-center text-muted" style="padding: 20px 0;">No tasks submitted yet. Start completing tasks to earn money!</p>';
        } else {
          const taskArray = Object.values(tasks).reverse();
          taskArray.forEach(task => {
            const date = new Date(task.submittedAt).toLocaleDateString('en-IN');
            let statusColor, statusIcon;
            if (task.status === 'approved') {
              statusColor = '#11998e';
              statusIcon = 'check-circle-fill';
            } else if (task.status === 'rejected') {
              statusColor = '#dc3545';
              statusIcon = 'x-circle-fill';
            } else {
              statusColor = '#ffc107';
              statusIcon = 'clock-fill';
            }
            
            html += `
              <div class="d-flex justify-content-between align-items-center mb-3 pb-3" style="border-bottom: 1px solid #eee;">
                <div>
                  <h6 style="margin: 0; font-weight: 600; color: #333;">${task.taskTitle || 'Task'}</h6>
                  <small class="text-muted">${date} • ₹${task.taskPrice || 2}</small>
                </div>
                <div class="text-end">
                  <i class="bi bi-${statusIcon}" style="color: ${statusColor}; font-size: 1.5rem;"></i>
                  <br>
                  <small style="color: ${statusColor}; font-weight: 600;">${task.status}</small>
                </div>
              </div>
            `;
          });
        }
        
        document.getElementById('taskHistory').innerHTML = html;
      }, (error) => {
        console.error('Error loading task history:', error);
        document.getElementById('taskHistory').innerHTML = '<p class="text-center text-muted">Error loading tasks</p>';
      });
    }
  </script>
</body>
</html>
