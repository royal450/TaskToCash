<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complete Task - Daily Campaign King</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="style.css">
</head>
<body style="background: #f5f7fa; margin: 0; padding: 0;">
  <nav class="navbar navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0; padding: 15px;">
    <div class="container-fluid" style="padding: 0 5px;">
      <span class="navbar-brand mb-0 h1"><i class="bi bi-clipboard-check"></i> Complete Task</span>
      <button onclick="window.location.href='dashboard.html'" class="btn btn-light btn-sm"><i class="bi bi-x-lg"></i></button>
    </div>
  </nav>

  <div class="container-fluid" style="padding: 15px 5px; max-width: 100%; margin-bottom: 20px;">
    <div id="upiPrompt" class="card shadow-sm mb-3" style="display: none; border: none; border-radius: 15px; border-left: 4px solid #11998e;">
      <div class="card-body" style="padding: 20px;">
        <h6 style="color: #11998e; font-weight: 600;"><i class="bi bi-wallet2"></i> Link Your UPI to Get Paid!</h6>
        <p class="text-muted mb-3" style="font-size: 0.9rem;">Add your UPI ID to receive instant payments</p>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-credit-card"></i></span>
          <input type="text" id="upiInput" class="form-control" placeholder="yourname@upi">
          <button onclick="saveUPI()" class="btn btn-success">Link</button>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-3" style="border: none; border-radius: 15px;">
      <div class="card-body" style="padding: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white;">
        <div class="text-center">
          <h4 id="taskTitle" style="font-weight: 700; margin-bottom: 10px;">Loading Task...</h4>
          <div class="d-flex justify-content-center align-items-center gap-3">
            <div style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px;">
              <small style="opacity: 0.9;">Earn</small>
              <h5 style="margin: 0; font-weight: 700;">₹<span id="taskPrice">0</span></h5>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card shadow-sm mb-3" style="border: none; border-radius: 15px; border-left: 4px solid #667eea;">
      <div class="card-body" style="padding: 20px;">
        <h6 style="color: #667eea; font-weight: 600; margin-bottom: 15px;"><i class="bi bi-info-circle-fill"></i> Instructions</h6>
        <ol style="padding-left: 20px; margin: 0; font-size: 0.9rem; line-height: 2;">
          <li>नीचे दिए गए comment को copy करें / Copy the comment below</li>
          <li>"Visit Link" बटन पर क्लिक करें / Click "Visit Link" button</li>
          <li>Google Maps पर review दें / Post the review on Maps</li>
          <li>29 seconds का timer पूरा होने का इंतजार करें / Wait for 29s timer</li>
          <li>Screenshot upload करें / Upload screenshot</li>
        </ol>
      </div>
    </div>

    <div id="taskContent">
      <div class="card shadow-sm mb-3" style="border: none; border-radius: 15px;">
        <div class="card-body" style="padding: 20px;">
          <h6 style="color: #11998e; font-weight: 600; margin-bottom: 15px;"><i class="bi bi-chat-quote-fill"></i> Review Comment</h6>
          <div class="comment-box" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 15px; border-radius: 10px; border-left: 4px solid #11998e;">
            <p id="reviewText" style="margin: 0; font-weight: 500; color: #333; line-height: 1.6;">Loading...</p>
          </div>
          <button onclick="copyComment()" class="btn btn-primary mt-3 w-100" style="border-radius: 10px; font-weight: 600;">
            <i class="bi bi-clipboard-check"></i> Copy Comment
          </button>
        </div>
      </div>

      <div class="card shadow-sm mb-3" style="border: none; border-radius: 15px;">
        <div class="card-body text-center" style="padding: 20px;">
          <a id="mapsLink" href="#" target="_blank" onclick="startTimer()" class="btn btn-lg w-100" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none; color: white; border-radius: 10px; padding: 15px; font-weight: 600; box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);">
            <i class="bi bi-link-45deg"></i> Visit Link & Post Review
          </a>
        </div>
      </div>

      <div id="timerSection" style="display: none;">
        <div class="card shadow-sm mb-3" style="border: none; border-radius: 15px;">
          <div class="card-body text-center" style="padding: 30px; background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); border-radius: 15px; color: white;">
            <h3 style="font-weight: 700; margin-bottom: 10px;"><i class="bi bi-hourglass-split"></i> Timer</h3>
            <h1 style="font-size: 3rem; font-weight: 700; margin: 0;"><span id="timer">29</span>s</h1>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">Please wait for the timer to complete...</p>
          </div>
        </div>
      </div>

      <div id="uploadSection" style="display: none;">
        <div class="card shadow-sm mb-3" style="border: none; border-radius: 15px;">
          <div class="card-body" style="padding: 20px;">
            <h6 style="color: #11998e; font-weight: 600; margin-bottom: 15px;"><i class="bi bi-image"></i> Upload Screenshot</h6>
            <input type="file" id="screenshot" class="form-control mb-3" accept="image/*" style="border: 2px dashed #11998e; padding: 15px; border-radius: 10px;">
            <button onclick="submitTask()" class="btn btn-success w-100 btn-lg" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border: none; border-radius: 10px; padding: 15px; font-weight: 600; box-shadow: 0 4px 15px rgba(56, 239, 125, 0.4);">
              <i class="bi bi-send-fill"></i> Submit Task & Earn ₹<span id="submitPrice">0</span>
            </button>
          </div>
        </div>
      </div>

      <div id="loadingMsg" style="display: none;" class="text-center py-5">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3" style="font-weight: 500;">Uploading your task...</p>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="script.js"></script>
  <script src="custom-auth.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const taskId = urlParams.get('taskId');
    
    let currentUser = null;
    let selectedComment = '';
    let currentTask = null;

    customAuth.onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        checkUPI(user.userId);
        loadTask();
      } else {
        window.location.href = 'index.html';
      }
    });

    function checkUPI(userId) {
      firebase.database().ref('users/' + userId).once('value', (snapshot) => {
        const data = snapshot.val();
        if (!data || !data.upiId) {
          document.getElementById('upiPrompt').style.display = 'block';
        }
      });
    }

    async function saveUPI() {
      const upi = document.getElementById('upiInput').value.trim();
      if (!upi) {
        Swal.fire({
          icon: 'warning',
          title: 'Invalid UPI',
          text: 'Please enter a valid UPI ID'
        });
        return;
      }

      try {
        await firebase.database().ref('users/' + currentUser.userId).update({ upiId: upi });
        document.getElementById('upiPrompt').style.display = 'none';
        Swal.fire({
          icon: 'success',
          title: 'UPI Linked!',
          text: 'You can now receive payments',
          timer: 1500,
          showConfirmButton: false
        });
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: error.message
        });
      }
    }

    function loadTask() {
      if (!taskId) {
        Swal.fire({
          icon: 'error',
          title: 'No Task Selected',
          text: 'Please select a task from the tasks page'
        }).then(() => {
          window.location.href = 'tasks-page.html';
        });
        return;
      }

      firebase.database().ref('adminTasks/' + taskId).once('value', (snapshot) => {
        const task = snapshot.val();
        
        if (!task || task.active === false) {
          Swal.fire({
            icon: 'error',
            title: 'Task Not Available',
            text: 'This task is no longer available'
          }).then(() => {
            window.location.href = 'tasks-page.html';
          });
          return;
        }

        currentTask = task;
        document.getElementById('taskTitle').textContent = task.title || 'Complete Task';
        document.getElementById('taskPrice').textContent = task.price || 2;
        document.getElementById('submitPrice').textContent = task.price || 2;
        
        if (task.comments && task.comments.length > 0) {
          const randomComment = task.comments[Math.floor(Math.random() * task.comments.length)];
          selectedComment = randomComment;
          document.getElementById('reviewText').textContent = randomComment;
        } else {
          document.getElementById('reviewText').textContent = 'No comment available for this task.';
        }
        
        document.getElementById('mapsLink').href = task.link || '#';
      });
    }

    function copyComment() {
      if (!selectedComment) {
        Swal.fire({
          icon: 'warning',
          title: 'No Comment',
          text: 'No comment available to copy'
        });
        return;
      }

      navigator.clipboard.writeText(selectedComment).then(() => {
        Swal.fire({
          icon: 'success',
          title: 'Copied!',
          text: 'Comment copied. Now click "Visit Link" to post review',
          timer: 2000,
          showConfirmButton: false
        });
      });
    }

    let timerInterval;
    function startTimer() {
      document.getElementById('timerSection').style.display = 'block';
      let seconds = 29;
      
      timerInterval = setInterval(() => {
        seconds--;
        document.getElementById('timer').textContent = seconds;
        
        if (seconds <= 0) {
          clearInterval(timerInterval);
          document.getElementById('timerSection').style.display = 'none';
          document.getElementById('uploadSection').style.display = 'block';
        }
      }, 1000);
    }

    // Optimized image compression function
    function compressImage(file, maxWidth = 1200, quality = 0.8) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob((blob) => {
              resolve(new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() }));
            }, 'image/jpeg', quality);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    async function submitTask() {
      const fileInput = document.getElementById('screenshot');
      const file = fileInput.files[0];
      
      if (!file) {
        Swal.fire({
          icon: 'warning',
          title: 'No Screenshot',
          text: 'Please upload a screenshot of your review'
        });
        return;
      }

      document.getElementById('uploadSection').style.display = 'none';
      document.getElementById('loadingMsg').style.display = 'block';

      try {
        const compressedFile = await compressImage(file);
        
        const storageRef = firebase.storage().ref();
        const screenshotRef = storageRef.child(`screenshots/${currentUser.userId}_${Date.now()}.jpg`);
        await screenshotRef.put(compressedFile);
        const screenshotUrl = await screenshotRef.getDownloadURL();

        const userSnapshot = await firebase.database().ref('users/' + currentUser.userId).once('value');
        const userEmail = userSnapshot.val().email;

        const taskRef = firebase.database().ref('tasks').push();
        await taskRef.set({
          userId: currentUser.userId,
          userEmail: userEmail,
          taskId: taskId,
          taskTitle: currentTask.title,
          taskPrice: currentTask.price || 2,
          screenshotUrl: screenshotUrl,
          status: 'pending',
          submittedAt: Date.now(),
          reviewText: selectedComment
        });

        notifyTaskSubmission(userEmail, currentTask.title, screenshotUrl, selectedComment);

        Swal.fire({
          icon: 'success',
          title: 'Task Submitted!',
          text: 'Admin will review and approve your task soon',
          confirmButtonText: 'OK'
        }).then(() => {
          window.location.href = 'dashboard.html';
        });

      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: error.message
        });
        document.getElementById('uploadSection').style.display = 'block';
        document.getElementById('loadingMsg').style.display = 'none';
      }
    }
  </script>
</body>
</html>
