<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile - Daily Campaign King</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="style.css">
</head>
<body style="background: #f5f7fa; margin: 0; padding: 0;">
  <nav class="navbar navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0; padding: 8px 0;">
    <div class="container-fluid" style="padding: 0 10px;">
      <span class="navbar-brand mb-0" style="font-size: 1.1rem; font-weight: 700;"><i class="bi bi-gift-fill"></i> Referral</span>
      <button onclick="logoutUser()" class="btn btn-light btn-sm" style="padding: 6px 12px; font-size: 0.85rem;"><i class="bi bi-box-arrow-right"></i> Logout</button>
    </div>
  </nav>

  <div class="container-fluid" style="padding: 15px 5px 120px 5px; max-width: 100%;">
    <div class="card shadow-sm" style="border: none; border-radius: 15px; margin-bottom: 70px;">
      <div class="card-body" style="padding: 20px;">
        <div class="text-center mb-4">
          <div class="profile-avatar mx-auto mb-3" style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">
            <i class="bi bi-person-fill"></i>
          </div>
          <h4 id="userEmail" style="color: #667eea; font-weight: 600;">Loading...</h4>
          <p class="text-muted" style="font-size: 0.9rem;">Member since <span id="joinDate">...</span></p>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-6">
            <div class="stat-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
              <h3 style="font-size: 2rem; margin: 0; font-weight: 700;">₹<span id="totalBalance">0</span></h3>
              <p style="margin: 5px 0 0 0; font-size: 0.85rem; opacity: 0.9;">Total Balance</p>
            </div>
          </div>
          <div class="col-6">
            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
              <h3 style="font-size: 2rem; margin: 0; font-weight: 700;"><span id="totalReferrals">0</span></h3>
              <p style="margin: 5px 0 0 0; font-size: 0.85rem; opacity: 0.9;">Total Referrals</p>
            </div>
          </div>
        </div>

        <div class="section-card mb-3" style="background: #fff; padding: 20px; border-radius: 12px; border-left: 4px solid #667eea;">
          <h5 style="color: #667eea; margin-bottom: 15px;"><i class="bi bi-gift-fill"></i> Referral Program</h5>
          <div class="mb-3">
            <label class="form-label" style="font-weight: 600; font-size: 0.9rem;">Your Referral Code</label>
            <div class="input-group">
              <input type="text" id="referralCode" class="form-control" readonly style="background: #f8f9fa; font-weight: 600; color: #667eea;">
              <button onclick="copyReferralCode()" class="btn btn-primary"><i class="bi bi-clipboard"></i></button>
            </div>
          </div>
          <div class="mb-2">
            <label class="form-label" style="font-weight: 600; font-size: 0.9rem;">Your Referral Link</label>
            <div class="input-group">
              <input type="text" id="referralLink" class="form-control" readonly style="background: #f8f9fa; font-size: 0.85rem;">
              <button onclick="shareReferralLink()" class="btn btn-success"><i class="bi bi-share-fill"></i></button>
            </div>
          </div>
          <small class="text-muted"><i class="bi bi-info-circle"></i> Earn ₹1 for each friend who signs up using your link!</small>
        </div>

        <div class="section-card" style="background: #fff; padding: 20px; border-radius: 12px; border-left: 4px solid #11998e;">
          <h5 style="color: #11998e; margin-bottom: 15px;"><i class="bi bi-graph-up"></i> Earnings Breakdown</h5>
          <div class="d-flex justify-content-between align-items-center mb-3 pb-3" style="border-bottom: 1px solid #eee;">
            <div>
              <p style="margin: 0; font-size: 0.9rem; color: #666;">Task Earnings</p>
              <h5 style="margin: 5px 0 0 0; color: #11998e; font-weight: 700;">₹<span id="taskEarnings">0</span></h5>
            </div>
            <i class="bi bi-clipboard-check" style="font-size: 2rem; color: #11998e; opacity: 0.3;"></i>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <p style="margin: 0; font-size: 0.9rem; color: #666;">Referral Earnings</p>
              <h5 style="margin: 5px 0 0 0; color: #f5576c; font-weight: 700;">₹<span id="referralEarnings">0</span></h5>
            </div>
            <i class="bi bi-people-fill" style="font-size: 2rem; color: #f5576c; opacity: 0.3;"></i>
          </div>
        </div>

        <a href="https://wa.me/919104037184?text=Hi%2C%20I%20need%20help%20with%20Daily%20Campaign%20King" target="_blank" class="btn w-100 mt-3" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border-radius: 10px; padding: 15px; border: none; font-weight: 600; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);">
          <i class="bi bi-whatsapp" style="font-size: 1.3rem;"></i> Contact Support on WhatsApp
        </a>
      </div>
    </div>
  </div>

  <nav class="bottom-nav">
    <a href="dashboard.html" class="nav-item">
      <i class="bi bi-house-door-fill"></i>
      <span>Home</span>
    </a>
    <a href="tasks-page.html" class="nav-item">
      <i class="bi bi-list-task"></i>
      <span>Tasks</span>
    </a>
    <a href="task-history.html" class="nav-item">
      <i class="bi bi-clock-history"></i>
      <span>History</span>
    </a>
    <a href="wallet.html" class="nav-item">
      <i class="bi bi-wallet2"></i>
      <span>Wallet</span>
    </a>
    <a href="profile.html" class="nav-item active">
      <i class="bi bi-gift-fill"></i>
      <span>Referral</span>
    </a>
  </nav>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="script.js"></script>
  <script src="custom-auth.js"></script>
  <script>
    let currentUser = null;
    let userReferralCode = '';

    customAuth.onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        loadUserData(user.userId);
        trackPageView('Profile');
      } else {
        window.location.href = 'index.html';
      }
    });

    function loadUserData(userId) {
      console.log('Loading user data for:', userId);
      firebase.database().ref('users/' + userId).on('value', (snapshot) => {
        const data = snapshot.val();
        console.log('User data received:', data);
        
        if (data) {
          document.getElementById('userEmail').textContent = data.email || 'Unknown';
          document.getElementById('totalBalance').textContent = data.balance || 0;
          document.getElementById('totalReferrals').textContent = data.totalReferrals || 0;
          document.getElementById('taskEarnings').textContent = data.taskEarnings || 0;
          document.getElementById('referralEarnings').textContent = data.referralEarnings || 0;
          document.getElementById('referralCode').value = data.referralCode || '';
          userReferralCode = data.referralCode || '';
          
          const referralLink = window.location.origin + '/signup.html?ref=' + userReferralCode;
          document.getElementById('referralLink').value = referralLink;

          if (data.joinedAt) {
            const joinDate = new Date(data.joinedAt).toLocaleDateString('en-IN');
            document.getElementById('joinDate').textContent = joinDate;
          } else {
            document.getElementById('joinDate').textContent = new Date().toLocaleDateString('en-IN');
          }
        } else {
          console.log('User data not found, initializing...');
          // Initialize user data if missing
          const newUserData = {
            email: currentUser.email,
            referralCode: 'REF' + userId.substring(0, 8).toUpperCase(),
            balance: 0,
            taskEarnings: 0,
            referralEarnings: 0,
            totalReferrals: 0,
            joinedAt: Date.now(),
            blocked: false,
            upiId: ''
          };
          firebase.database().ref('users/' + userId).set(newUserData).then(() => {
            console.log('User data initialized successfully');
            location.reload();
          });
        }
      }, (error) => {
        console.error('Error loading user data:', error);
      });
    }

    function copyReferralCode() {
      const code = document.getElementById('referralCode').value;
      navigator.clipboard.writeText(code).then(() => {
        Swal.fire({
          icon: 'success',
          title: 'Copied!',
          text: 'Referral code copied to clipboard',
          timer: 1500,
          showConfirmButton: false
        });
      });
    }

    function shareReferralLink() {
      const link = document.getElementById('referralLink').value;
      if (navigator.share) {
        navigator.share({
          title: 'Join Daily Campaign King',
          text: 'Use my referral link to join and earn money!',
          url: link
        }).catch(() => {
          copyToClipboard(link);
        });
      } else {
        copyToClipboard(link);
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        Swal.fire({
          icon: 'success',
          title: 'Link Copied!',
          text: 'Share it to earn ₹1 per signup',
          timer: 2000,
          showConfirmButton: false
        });
      });
    }

    function logoutUser() {
      customAuth.signOut();
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>
